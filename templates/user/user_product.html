<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} | {{ shop.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0a0a0c; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .cyber-panel { background: #111114; border: 1px solid rgba(0, 242, 255, 0.1); }
        .cart-sidebar { transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: #0d0d0f; border-left: 2px solid #00f2ff; z-index: 1000; }
        .hidden-cart { transform: translateX(100%); }

        /* FLY EFFECT CSS */
        .flying-img {
            position: fixed;
            z-index: 1001;
            border-radius: 12px;
            border: 2px solid #00f2ff;
            object-fit: cover;
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.42, 0, 0.58, 1);
        }

        @keyframes basket-shake {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(15deg); }
        }
        .shake-animation { animation: basket-shake 0.4s ease-in-out; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #00f2ff; border-radius: 10px; }
    </style>
</head>
<body>

    <header class="p-4 border-b border-gray-800 flex justify-between items-center sticky top-0 bg-black/95 backdrop-blur-md z-50">
        <div class="flex items-center gap-4">
            <a href="/shop/{{ shop.slug }}/" class="w-10 h-10 bg-gray-900 border border-gray-700 rounded-xl flex items-center justify-center text-cyan-400 hover:border-cyan-500 transition">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            <h1 class="text-lg font-black uppercase text-white truncate">{{ product.name }}</h1>
        </div>

        <button id="cart-btn-main" onclick="toggleCart()" class="relative p-2 transition-transform active:scale-90 flex items-center justify-center group">
            <i class="fa-solid fa-cart-shopping text-3xl text-cyan-400 group-hover:text-cyan-300"></i>
            <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full h-5 w-5 flex items-center justify-center font-bold border-2 border-black leading-none">
                {{ cart_items|length }}
            </span>
        </button>
    </header>

    <main class="max-w-6xl mx-auto p-6 mt-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">

            <div class="relative group">
                <div class="absolute -inset-1 bg-cyan-500 rounded-3xl blur opacity-10 group-hover:opacity-30 transition"></div>
                <div id="main-product-img-container" class="relative cyber-panel rounded-3xl overflow-hidden aspect-square">
                    {% if product.image %}
                        <img id="product-img" src="{{ product.image.url }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-700 italic">Rasm yo'q</div>
                    {% endif %}
                </div>
            </div>

            <div class="flex flex-col gap-8">
                <div>
                    <h2 class="text-4xl md:text-5xl font-black text-white mb-4">{{ product.name }}</h2>
                    <span class="text-3xl font-black text-cyan-400">{{ product.price }} so'm</span>
                </div>

                <div class="bg-gray-900/30 p-6 rounded-2xl border border-gray-800 text-gray-300 leading-relaxed">
                    {{ product.description|linebreaks }}
                </div>

                <div class="text-sm text-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-box-open text-cyan-500"></i>
                    Omborda: {{ product.stock }} dona
                </div>

                <button onclick="cartAction('add', '{{ product.id }}', {{ product.stock }}, getInCartQty('{{ product.id }}'))"
                        class="w-full bg-cyan-500 hover:bg-cyan-400 text-black py-5 rounded-2xl font-black text-sm uppercase tracking-widest transition-all transform active:scale-95 shadow-[0_0_20px_rgba(6,182,212,0.3)] flex items-center justify-center gap-3">
                    <i class="fa-solid fa-plus"></i>
                    Savatga qo'shish
                </button>
            </div>
        </div>
    </main>

    <div id="cartSidebar" class="fixed top-0 right-0 h-full w-full md:w-[450px] cart-sidebar hidden-cart p-6 flex flex-col shadow-[-20px_0_50px_rgba(0,0,0,0.5)]">
        <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
            <h2 class="text-xl font-black text-cyan-400 uppercase italic">Savatingiz</h2>
            <button onclick="toggleCart()" class="text-3xl text-gray-500 hover:text-white transition">&times;</button>
        </div>

        <div id="cart-content" class="flex-grow overflow-y-auto space-y-4 pr-2">
            {% for item in cart_items %}
                <div class="bg-gray-900/80 p-4 rounded-2xl border border-gray-800 flex flex-col gap-3 relative">
                    <div class="flex justify-between items-start">
                        <h5 class="text-sm font-bold text-white uppercase truncate pr-4">{{ item.product.name }}</h5>
                        <button onclick="cartAction('delete', '{{ item.product.id }}')" class="text-gray-600 hover:text-red-500">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center bg-black/50 rounded-lg border border-gray-700">
                            <button onclick="cartAction('remove', '{{ item.product.id }}')" class="w-8 h-8 flex items-center justify-center text-cyan-400">-</button>
                            <span id="qty-{{ item.product.id }}" class="px-4 font-bold text-sm text-white">{{ item.quantity }}</span>
                            <button onclick="cartAction('add', '{{ item.product.id }}', {{ item.product.stock }}, {{ item.quantity }})" class="w-8 h-8 flex items-center justify-center text-cyan-400">+</button>
                        </div>
                        <span class="text-sm font-black text-cyan-400">{{ item.item_total }} so'm</span>
                    </div>
                </div>
            {% empty %}
                <div class="flex flex-col items-center justify-center h-full opacity-20 italic">
                    <i class="fa-solid fa-cart-ghost text-6xl mb-4"></i>
                    <p>Savat bo'sh...</p>
                </div>
            {% endfor %}
        </div>

        <div class="mt-auto pt-6 border-t border-gray-800">
            {% if cart_items %}
            <div class="flex justify-between items-end mb-6">
                <button onclick="cartAction('clear', '0')" class="text-[10px] text-red-500 uppercase font-bold">Tozalash</button>
                <div class="text-right">
                    <span class="text-gray-500 text-[10px] uppercase block mb-1">Jami:</span>
                    <span class="text-2xl font-black text-cyan-400">{{ total_price }} so'm</span>
                </div>
            </div>
            <button class="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-2xl font-black text-sm uppercase tracking-widest transition active:scale-95">
                Buyurtma berish
            </button>
            {% endif %}
        </div>
    </div>

    <script>
        const shopSlug = "{{ shop.slug }}";

        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('hidden-cart');
        }

        function getInCartQty(pId) {
            const qtyElem = document.getElementById('qty-' + pId);
            return qtyElem ? parseInt(qtyElem.innerText) : 0;
        }

        function cartAction(action, productId, stock, currentQty) {
            if (action === 'add' && stock !== undefined && currentQty >= stock) {
                alert("Omborda yetarli mahsulot yo'q!");
                return;
            }

            // FLY EFFECT
            if (action === 'add') {
                const img = document.getElementById('product-img');
                const cart = document.getElementById('cart-btn-main');
                if (img && cart) {
                    const fly = img.cloneNode();
                    const iRect = img.getBoundingClientRect();
                    const cRect = cart.getBoundingClientRect();

                    Object.assign(fly.style, {
                        position: 'fixed', left: iRect.left+'px', top: iRect.top+'px',
                        width: iRect.width+'px', height: iRect.height+'px',
                        zIndex: 1001, borderRadius: '20px', transition: 'all 0.8s ease-in-out',
                        pointerEvents: 'none', border: '2px solid #06b6d4'
                    });

                    document.body.appendChild(fly);
                    setTimeout(() => {
                        Object.assign(fly.style, {
                            left: (cRect.left+15)+'px', top: (cRect.top+15)+'px',
                            width: '20px', height: '20px', opacity: '0.2'
                        });
                    }, 50);
                    setTimeout(() => {
                        fly.remove();
                        cart.classList.add('shake-animation');
                        setTimeout(() => cart.classList.remove('shake-animation'), 400);
                    }, 850);
                }
            }

            let url = "";
            if (action === 'add') url = `/shop/${shopSlug}/add-to-basket/${productId}/`;
            else if (action === 'remove') url = `/shop/${shopSlug}/remove/${productId}/`;
            else if (action === 'delete') url = `/shop/${shopSlug}/delete/${productId}/`;
            else if (action === 'clear') url = `/shop/${shopSlug}/clear/`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(() => fetch(window.location.href))
            .then(res => res.text())
            .then(html => {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                document.getElementById('cartSidebar').innerHTML = doc.getElementById('cartSidebar').innerHTML;
                document.getElementById('cart-badge').innerText = doc.getElementById('cart-badge').innerText;
                // Savat ochilmaydi, faqat fly effect bo'ladi
            });
        }
    </script>
</body>
</html>